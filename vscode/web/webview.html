<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    body {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    iframe {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      border: 0px;
    }
  </style>
  <script>
    const TYPE_REQUEST = 1;
    const TYPE_RESPONSE = 2;
    const STATUS_SUCCESS = 0;
    const STATUS_ERROR = -1;

    (() => {
      let __apiVscode = acquireVsCodeApi();
      let cache = {};
      //监控来自Server端的结果数据
      window.addEventListener('message', async (event) => {
        let { uuid, type, data, status, msg,client } = event.data;
        if (TYPE_RESPONSE == type && cache[uuid] && !client) {
          let resolve = cache[uuid];
          delete cache[uuid];
          resolve({ type, data, status, msg });
        }
      });

      //向服务端请求数据
      let apiRequest = ({ method, data }) => {
        let uuid = Date.now() + '' + Math.round(Math.random() * 100000);
        return new Promise((resolve, reject) => {
          cache[uuid] = resolve;
          __apiVscode.postMessage({ uuid, type: TYPE_REQUEST, method, data }, "*");
        })
      }


      //监控来自Client端的请求数据
      window.addEventListener('message', async (event) => {
        let { uuid, type, method, data, client } = event.data;
        if (TYPE_REQUEST == type && client) {
          const apiRes = await apiRequest({ method, data });
          event.source.postMessage({ type: TYPE_RESPONSE, data: apiRes.data, status: apiRes.status, msg: apiRes.msg, uuid }, event.origin);
          return;
        }
      });
    })();

  </script>
</head>

<body>
  <iframe src="${IFRAME}"></iframe>
</body>

</html>